<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="深入JVM"><meta name="keywords" content="Java"><meta name="author" content="高明"><meta name="copyright" content="高明"><title>深入JVM | SkySea-GaoMing</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#参考《深入理解JVM虚拟机》"><span class="toc-number">1.</span> <span class="toc-text">参考《深入理解JVM虚拟机》</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Java简介"><span class="toc-number">1.1.</span> <span class="toc-text">Java简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM架构"><span class="toc-number">1.2.</span> <span class="toc-text">JVM架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JVM的生命周期"><span class="toc-number">1.3.</span> <span class="toc-text">JVM的生命周期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#类加载器"><span class="toc-number">1.4.</span> <span class="toc-text">类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#链接"><span class="toc-number">1.4.1.</span> <span class="toc-text">链接</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#初始化"><span class="toc-number">1.4.2.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#类加载器分类"><span class="toc-number">1.4.3.</span> <span class="toc-text">类加载器分类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#双亲委派机制"><span class="toc-number">1.4.4.</span> <span class="toc-text">双亲委派机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#沙箱安全机制"><span class="toc-number">1.4.5.</span> <span class="toc-text">沙箱安全机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#补充"><span class="toc-number">1.4.6.</span> <span class="toc-text">补充</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#运行时数据区内部结构"><span class="toc-number">2.</span> <span class="toc-text">运行时数据区内部结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#内存"><span class="toc-number">2.1.</span> <span class="toc-text">内存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程"><span class="toc-number">2.2.</span> <span class="toc-text">线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#程序计数器介绍"><span class="toc-number">2.3.</span> <span class="toc-text">程序计数器介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#PC-Register"><span class="toc-number">2.3.1.</span> <span class="toc-text">PC Register</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#作用"><span class="toc-number">2.3.2.</span> <span class="toc-text">作用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#例子"><span class="toc-number">2.3.3.</span> <span class="toc-text">例子</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#两个常见问题"><span class="toc-number">2.3.4.</span> <span class="toc-text">两个常见问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CPU时间片"><span class="toc-number">2.3.5.</span> <span class="toc-text">CPU时间片</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#虚拟机栈"><span class="toc-number">2.4.</span> <span class="toc-text">虚拟机栈</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#虚拟机栈的概述"><span class="toc-number">2.4.1.</span> <span class="toc-text">虚拟机栈的概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈帧的粗略描述"><span class="toc-number">2.4.2.</span> <span class="toc-text">栈帧的粗略描述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈的优点"><span class="toc-number">2.4.3.</span> <span class="toc-text">栈的优点</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈中可能出现的异常"><span class="toc-number">2.4.4.</span> <span class="toc-text">栈中可能出现的异常</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置栈内存大小"><span class="toc-number">2.4.5.</span> <span class="toc-text">设置栈内存大小</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈的存储单位"><span class="toc-number">2.4.6.</span> <span class="toc-text">栈的存储单位</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈运行原理"><span class="toc-number">2.4.7.</span> <span class="toc-text">栈运行原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈帧的内部结构"><span class="toc-number">2.4.8.</span> <span class="toc-text">栈帧的内部结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#局部变量表"><span class="toc-number">2.4.9.</span> <span class="toc-text">局部变量表</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#字节码中方法内部结构剖析"><span class="toc-number">2.4.10.</span> <span class="toc-text">字节码中方法内部结构剖析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Slot"><span class="toc-number">2.4.11.</span> <span class="toc-text">Slot</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#静态变量与局部变量的对比"><span class="toc-number">2.4.12.</span> <span class="toc-text">静态变量与局部变量的对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#操作数栈"><span class="toc-number">2.4.13.</span> <span class="toc-text">操作数栈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#代码追踪"><span class="toc-number">2.4.14.</span> <span class="toc-text">代码追踪</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#栈顶缓存技术"><span class="toc-number">2.4.15.</span> <span class="toc-text">栈顶缓存技术</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#动态链接"><span class="toc-number">2.5.</span> <span class="toc-text">动态链接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法的调用"><span class="toc-number">2.6.</span> <span class="toc-text">方法的调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#虚方法和非虚方法"><span class="toc-number">2.6.1.</span> <span class="toc-text">虚方法和非虚方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#invokedynamic指令"><span class="toc-number">2.6.2.</span> <span class="toc-text">invokedynamic指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#方法的重写"><span class="toc-number">2.6.3.</span> <span class="toc-text">方法的重写</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#方法返回地址"><span class="toc-number">2.7.</span> <span class="toc-text">方法返回地址</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一些附加信息"><span class="toc-number">2.8.</span> <span class="toc-text">一些附加信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#栈的相关面试题"><span class="toc-number">2.9.</span> <span class="toc-text">栈的相关面试题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#本地方法栈"><span class="toc-number">2.10.</span> <span class="toc-text">本地方法栈</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#堆"><span class="toc-number">2.11.</span> <span class="toc-text">堆</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#堆的核心概述"><span class="toc-number">2.11.1.</span> <span class="toc-text">堆的核心概述</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#堆内存细分"><span class="toc-number">2.11.2.</span> <span class="toc-text">堆内存细分</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#设置堆内存大小与OOM"><span class="toc-number">2.11.3.</span> <span class="toc-text">设置堆内存大小与OOM</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#堆空间的大小设置和查看"><span class="toc-number">2.11.4.</span> <span class="toc-text">堆空间的大小设置和查看</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OutOfMemory"><span class="toc-number">2.11.5.</span> <span class="toc-text">OutOfMemory</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#年轻代与老年代"><span class="toc-number">2.11.6.</span> <span class="toc-text">年轻代与老年代</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#本地方法接口"><span class="toc-number">3.</span> <span class="toc-text">本地方法接口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JVM学习回顾"><span class="toc-number">4.</span> <span class="toc-text">JVM学习回顾</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1582898893694&amp;di=15958b0625c3bcbdd505353b8b5deaa4&amp;imgtype=0&amp;src=http%3A%2F%2Fi0.hdslb.com%2Fbfs%2Farticle%2F068c0cbf1b1571976ada2e55a53b3a079e1614c5.jpg"></div><div class="author-info__name text-center">高明</div><div class="author-info__description text-center">JAVA</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">29</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">10</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1591954918112&amp;di=2bc6f4358ea0e880687f5ced03157daf&amp;imgtype=0&amp;src=http%3A%2F%2Fyouimg1.c-ctrip.com%2Ftarget%2Ftg%2F620%2F406%2F859%2Fe7db3299a728401eb7b42effae33dadb.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">SkySea-GaoMing</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">深入JVM</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-05-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E5%90%8E%E7%AB%AF%E6%8A%80%E6%9C%AF/">后端技术</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2020/05/06/深入JVM/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="参考《深入理解JVM虚拟机》"><a href="#参考《深入理解JVM虚拟机》" class="headerlink" title="参考《深入理解JVM虚拟机》"></a>参考《深入理解JVM虚拟机》</h2><p>世界上没有完美的程序，但是我们并不因此沮丧，因为写程序本来就是一个不<br>断追求完美的过程</p>
<h3 id="Java简介"><a href="#Java简介" class="headerlink" title="Java简介"></a>Java简介</h3><ol>
<li>c/c++编译生成的可执行文件跟操作系统和指令集架构都有关系。满足相同<br>的操作系统和指令集架构这两个条件才可以执行这个可执行文件。指令集不<br>同  很好理解，如果指令集相同操作系统不同也是不能执行的。原因如下，<br>参考<a href="https://www.zhihu.com/question/22672994" target="_blank" rel="noopener">https://www.zhihu.com/question/22672994</a>  </li>
</ol>
<ul>
<li>一个可执行文件除了机器指令还包括各种数据和运行时资源，并且文件的格<br>式也不同</li>
<li>可执行文件执行前操作系统要有一些准备工作，不同的操作系统准备工作<br>不同</li>
<li>一个可执行文件所执行的绝大多数操作（比如：文件操作、输入输出、内存<br>申请释放、任务调度等等）都需要与操作系统交互才能完成，而不同的操作<br>系统使用这些操作的方法完全不同Java的一大特点就是摆脱了硬件平台的束<br>缚，一次编写到处运行，这跟c/c++有很大的区别 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number6.jpg" alt></li>
</ul>
<ol start="2">
<li>java虚拟机的功能比Java要强大，实际上是跨语言的平台，不同的编程<br>语言编写的程序也可以编译成字节码文件，如果符合虚拟机规范也可以在虚<br>拟机上运行，实际上能在jvm平台执行的字节码格式都是一样的，统称为<br>jvm字节码 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number7.jpg" alt></li>
<li>JDK是用于支持Java程序开发的最小环境,JRE是支持Java程序运行的<br>标准环境</li>
</ol>
<ul>
<li>Java程序设计语言，Java虚拟机，JavaAPI类库组成JDK</li>
<li>Java虚拟机，Java SE API组成JRE</li>
</ul>
<ol start="4">
<li>编译过程 编译器（javac）将Java代码翻译成字节码，也叫做前端编<br>译器，因为操作系统并不能识别字节码，所以Java虚拟机中的执行引擎中<br>的JIT编译器要将字节码翻译成机器指令  被CPU执行，所以JIT被称为后<br>端编译器</li>
<li>运行过程 Java虚拟机能够将字节码解释成具体平台的机器码 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number8.jpg" alt></li>
<li>虚拟机 是一台虚拟的计算机，也就是一个软件，用来执行一系列虚<br>拟计算机指令 </li>
</ol>
<ul>
<li>系统虚拟机 VisualBox VMware 完全对物理计算机的仿真，提供一个<br>可运行完整操作系统的软件平台，实际上模拟的是上图硬件</li>
<li>程序虚拟机 Java虚拟机 专门为执行单个计算机程序而设计，Java虚<br>拟机中执行的指令称为Java字节码指令，Java字节码是可以运行在任何<br>支持Java虚拟机的硬件平台和操作系统上的二进制文件，字节码的执行<br>实际上是被翻译成机器代码而执行的过程。实际上模拟的是上图JVM</li>
</ul>
<h3 id="JVM架构"><a href="#JVM架构" class="headerlink" title="JVM架构"></a>JVM架构</h3><ol>
<li>HotSpot虚拟机 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number12.jpg" alt></li>
<li>JVM的整体结构 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number2.jpg" alt></li>
</ol>
<ul>
<li>Java代码执行流程 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number9.jpg" alt></li>
<li>指令集架构分为两种，Java编译器输入的指令流基本上是一种基于<br>栈的指令集架构 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number10.jpg" alt>，以下是2+3操作字节码指令<br>和机器指令<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iconst_2 &#x2F;&#x2F;常量2入栈</span><br><span class="line">istore_1 </span><br><span class="line">iconst_3 </span><br><span class="line">isotre_2</span><br><span class="line">iload_1  &#x2F;&#x2F;取出局部变量表索引为1的数据入栈</span><br><span class="line">iload_2</span><br><span class="line">iadd &#x2F;&#x2F;从操作数栈中出栈两次计算相加结果然后入栈</span><br><span class="line">isotre_0</span><br><span class="line"></span><br><span class="line">mov $2, %eax</span><br><span class="line">add $3, %eax</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="JVM的生命周期"><a href="#JVM的生命周期" class="headerlink" title="JVM的生命周期"></a>JVM的生命周期</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number13.jpg" alt></p>
<ol>
<li>虚拟机的启动 通过引导类加载器创建一个初始类来完成，这个类<br>是由虚拟机的具体实现指定</li>
<li>虚拟机的执行 执行Java程序，程序开始执行时执行，程序结束时<br>结束。实际上执行的是一个进程 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number89.jpg" alt> 进程执行结束<br>后 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number90.jpg" alt></li>
<li>虚拟机的退出</li>
</ol>
<ul>
<li>程序正常结束</li>
<li>程序遇到异常或错误</li>
<li>操作系统错误</li>
<li>Runtime类或System类的exit方法</li>
</ul>
<h3 id="类加载器"><a href="#类加载器" class="headerlink" title="类加载器"></a>类加载器</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number14.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number15.jpg" alt></p>
<ol>
<li>加载</li>
</ol>
<ul>
<li>通过一个类的全限定名获取定义此类的二进制字节流 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number16.jpg" alt></li>
<li>将这个字节流所代表的静态存储结构转化为方法区的运行时数据区</li>
<li>在内存中生成一个代表这个类的java.lang.Class对象，作为方法<br>区这个类的各种数据的访问入口</li>
</ul>
<h4 id="链接"><a href="#链接" class="headerlink" title="链接"></a>链接</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number17.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number18.jpg" alt></p>
<ol>
<li>Verify 字节码文件的开头都是cafebabe</li>
<li>Prepare 这个阶段a=0<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloApp</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> a=<span class="number">1</span>;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number19.jpg" alt></p>
<ol>
<li>以下代码是允许的，链接时将num和number都赋值为0，初始<br>化时将赋值动作和静态代码块按顺序执，最终number的值为1，但<br>是不能有打印语句，在number声明之前可以赋值但是不能引用</li>
<li>如果不存在类变量或static代码块就不会存在clinit方法，<br>类变量必须要加static，否则就是实例变量</li>
<li><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Init</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> num=<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		num=<span class="number">2</span>;</span><br><span class="line">		number=<span class="number">10</span>;</span><br><span class="line">		<span class="comment">//System.out.println(number);</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> number=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="类加载器分类"><a href="#类加载器分类" class="headerlink" title="类加载器分类"></a>类加载器分类</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number20.jpg" alt></p>
<ol>
<li>引导类加载器 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number24.jpg" alt></li>
<li>自定义类加载器，Java虚拟机规范定定义所有派生于抽象<br>类ClassLoader的类加载器都划分为自定义类加载器<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number21.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number22.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number23.jpg" alt></li>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number25.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number26.jpg" alt></li>
<li>用户自定义类加载器 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number27.jpg" alt></li>
</ol>
<ul>
<li>隔离加载类</li>
<li>修改类加载的方式</li>
<li>扩展加载源</li>
<li>防止源码泄露</li>
</ul>
<ol start="5">
<li>ClassLoader 是一个抽象类，所有类加载器都继承自<br>ClassLoader（除了引导类加载器）<img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number28.jpg" alt><br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number29.jpg" alt></li>
</ol>
<h4 id="双亲委派机制"><a href="#双亲委派机制" class="headerlink" title="双亲委派机制"></a>双亲委派机制</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number30.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number31.jpg" alt><br>自己定义了一个java.lang.String类，系统类加载器加载<br>时首先往上委托，发现引导类加载器可以加载java.lang.String，<br>所以自己定义的java.lang.String不会被加载</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span>&#123;</span><br><span class="line">	<span class="keyword">static</span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"自己定义的String类"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		java.lang.String a=<span class="keyword">new</span> java.lang.String();</span><br><span class="line">		System.out.println(<span class="string">"到底加载了哪个String"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number32.jpg" alt> 优势是避免类的重复加载，保护程序安全，防<br>止核心API被随意篡改</p>
<h4 id="沙箱安全机制"><a href="#沙箱安全机制" class="headerlink" title="沙箱安全机制"></a>沙箱安全机制</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number33.jpg" alt></p>
<h4 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h4><ol>
<li>在JVM中表示两个Class对象是否为同一个类存在两个<br>必要条件</li>
</ol>
<ul>
<li>类的完整类名必须一致，包括包名</li>
<li>加载这个类的ClassLoader必须相同</li>
</ul>
<ol start="2">
<li>JVM必须知道一个类型是由哪个类加载器加载的<br>（是启动还是用户）。如果是用户类加载器加载<br>的，那么JVM会将这个类加载器的一个引用作为类型信息的<br>一部分保存在方法区中。当解析一个类型到另一个类型的引用<br>时，JVM需要保证这两个类型的类加载器是相同的</li>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number34.jpg" alt></li>
</ol>
<h2 id="运行时数据区内部结构"><a href="#运行时数据区内部结构" class="headerlink" title="运行时数据区内部结构"></a>运行时数据区内部结构</h2><p>一个进程对应一个红色区域，一个线程对应一个灰色区域  <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number35.jpg" alt></p>
<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number36.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number37.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number38.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number39.jpg" alt></p>
<h3 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number40.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number41.jpg" alt></p>
<h3 id="程序计数器介绍"><a href="#程序计数器介绍" class="headerlink" title="程序计数器介绍"></a>程序计数器介绍</h3><h4 id="PC-Register"><a href="#PC-Register" class="headerlink" title="PC Register"></a>PC Register</h4><p>java虚拟机中存在PC寄存器，也可以叫做程序计数器 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number42.jpg" alt></p>
<h4 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h4><ol>
<li>是一块很小的内存空间，也是运行速度最快的存储区域</li>
<li>每个线程都有自己的程序计数器，生命周期与线程的<br>生命周期一致</li>
<li>任何时间一个线程都只有一个方法在执行，也就是当<br>前方法，程序计数器会存储当前线程正在执行的Java方<br>法的JVM指令地址，如果执行native方法则未指定值<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number43.jpg" alt></li>
</ol>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>虚拟机执行字节码指令实际是通过生成机器指令执行的 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number44.jpg" alt></p>
<h4 id="两个常见问题"><a href="#两个常见问题" class="headerlink" title="两个常见问题"></a>两个常见问题</h4><ol>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number45.jpg" alt></li>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number46.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number47.jpg" alt></li>
</ol>
<h4 id="CPU时间片"><a href="#CPU时间片" class="headerlink" title="CPU时间片"></a>CPU时间片</h4><ul>
<li>串行 线程排成队依次被CPU执行</li>
<li>并行 多个线程同时被执行</li>
<li>并发 一个CPU快速切换线程，看起来像是并行<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number48.jpg" alt></li>
</ul>
<h3 id="虚拟机栈"><a href="#虚拟机栈" class="headerlink" title="虚拟机栈"></a>虚拟机栈</h3><h4 id="虚拟机栈的概述"><a href="#虚拟机栈的概述" class="headerlink" title="虚拟机栈的概述"></a>虚拟机栈的概述</h4><p>java虚拟机栈早期也叫Java栈，每个线程创建时都会创<br>建一个虚拟机栈，其内部保存一个个栈帧，对应一次次<br>的Java方法调用，生命周期和线程一致，主管Java程序<br>的运行，保存方法的局部变量、部分结果，并参与方法的<br>调用和返回。局部变量包括8中基本数据类型和对象的引用地址<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number49.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number50.jpg" alt></p>
<h4 id="栈帧的粗略描述"><a href="#栈帧的粗略描述" class="headerlink" title="栈帧的粗略描述"></a>栈帧的粗略描述</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number51.jpg" alt></p>
<h4 id="栈的优点"><a href="#栈的优点" class="headerlink" title="栈的优点"></a>栈的优点</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number52.jpg" alt></p>
<h4 id="栈中可能出现的异常"><a href="#栈中可能出现的异常" class="headerlink" title="栈中可能出现的异常"></a>栈中可能出现的异常</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number53.jpg" alt></p>
<h4 id="设置栈内存大小"><a href="#设置栈内存大小" class="headerlink" title="设置栈内存大小"></a>设置栈内存大小</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number54.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number55.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number56.jpg" alt></p>
<h4 id="栈的存储单位"><a href="#栈的存储单位" class="headerlink" title="栈的存储单位"></a>栈的存储单位</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number57.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number58.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number59.jpg" alt></p>
<h4 id="栈运行原理"><a href="#栈运行原理" class="headerlink" title="栈运行原理"></a>栈运行原理</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number60.jpg" alt></p>
<h4 id="栈帧的内部结构"><a href="#栈帧的内部结构" class="headerlink" title="栈帧的内部结构"></a>栈帧的内部结构</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number61.jpg" alt></p>
<h4 id="局部变量表"><a href="#局部变量表" class="headerlink" title="局部变量表"></a>局部变量表</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number62.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number66.jpg" alt>  解析<br>字节码文件 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number63.jpg" alt> </p>
<ol>
<li>main方法所在的栈帧中 locals=3 表示局部变量<br>表的长度 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number64.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number65.jpg" alt></li>
</ol>
<h4 id="字节码中方法内部结构剖析"><a href="#字节码中方法内部结构剖析" class="headerlink" title="字节码中方法内部结构剖析"></a>字节码中方法内部结构剖析</h4><p>在IDEA插件中下载jclasslib，在view中show bytecode<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number70.jpg" alt></p>
<ul>
<li>public static + void + main，参数是String<br>型数组 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number71.jpg" alt></li>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number72.jpg" alt></li>
</ul>
<h4 id="Slot"><a href="#Slot" class="headerlink" title="Slot"></a>Slot</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number67.jpg" alt> 静态方法的局部变量表中没有this，<br>所以不能在静态方法中引用this <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number68.jpg" alt><br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number69.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number73.jpg" alt><br>变量c使用之前已经销毁的变量b占据的slot的位置 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number74.jpg" alt></p>
<h4 id="静态变量与局部变量的对比"><a href="#静态变量与局部变量的对比" class="headerlink" title="静态变量与局部变量的对比"></a>静态变量与局部变量的对比</h4><ol>
<li>按数据类型分类 基本数据类型和引用数据类型</li>
<li>按照在类中声明的位置 成员变量和局部变量，成员变<br>量又可分为是否用static修饰。如果static修饰就是类<br>变量否则就是实例变量</li>
<li>成员变量在使用前都被默认初始化，在类加载过程的<br>链接中的准备阶段给类变量默认赋值，在initial阶段给<br>类变量显式赋值以及静态代码块赋值。实例变量随着对象<br>的创建会在堆空间中分配实例变量空间并进行默认赋值</li>
<li>局部变量在使用前必须进行显式赋值</li>
<li>如果局部变量表中没有指向堆的一个引用那么就会进<br>行垃圾回收 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number75.jpg" alt></li>
</ol>
<h4 id="操作数栈"><a href="#操作数栈" class="headerlink" title="操作数栈"></a>操作数栈</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number76.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number77.jpg" alt><br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number78.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number79.jpg" alt></p>
<h4 id="代码追踪"><a href="#代码追踪" class="headerlink" title="代码追踪"></a>代码追踪</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number80.jpg" alt> </p>
<ol>
<li>一开始指令地址指向0，局部变量表中只有this，<br>将15（int）放入操作数栈，然后指令地址<br>指向2，执行出栈操作，同时局部变量表中加入15 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number81.jpg" alt></li>
<li><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number82.jpg" alt></li>
<li>从局部变量表中依次取出索引为1和2的数据放入<br>操作数栈中 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number83.jpg" alt></li>
<li>iadd指令被执行引擎翻译成机器指令被CPU执行，将<br>操作数栈中的两个数出栈然后进行加法运算将结果放入<br>操作数栈中 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number84.jpg" alt></li>
<li>对于有返回值的情况，获取上一个栈帧返回的结果<br>并保存在操作数栈中 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number85.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number86.jpg" alt></li>
</ol>
<h4 id="栈顶缓存技术"><a href="#栈顶缓存技术" class="headerlink" title="栈顶缓存技术"></a>栈顶缓存技术</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number87.jpg" alt></p>
<h3 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h3><p>帧数据区：动态链接，一些附加信息，方法返回地址<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number88.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number91.jpg" alt> 所有的变量<br>和方法引用都作为符号引用保存在常量池中<br><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number92.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number93.jpg" alt></p>
<h3 id="方法的调用"><a href="#方法的调用" class="headerlink" title="方法的调用"></a>方法的调用</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number94.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number95.jpg" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> num=<span class="number">10</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Animal</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"eat"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">Huntable</span></span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">hunt</span><span class="params">()</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> <span class="keyword">extends</span> <span class="title">Animal</span> <span class="keyword">implements</span> <span class="title">Huntable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"dog eat meat"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hunt</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"dog hunt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Cat</span> <span class="keyword">extends</span> <span class="title">Animal</span> <span class="keyword">implements</span> <span class="title">Huntable</span></span></span><br><span class="line"><span class="class">    </span>&#123;</span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">    		<span class="keyword">super</span>(); <span class="comment">//早期绑定</span></span><br><span class="line">    	&#125;</span><br><span class="line">    	<span class="function"><span class="keyword">public</span> <span class="title">Cat</span><span class="params">(String name)</span></span></span><br><span class="line"><span class="function">    	</span>&#123;</span><br><span class="line">    		<span class="keyword">this</span>(); <span class="comment">//早期绑定</span></span><br><span class="line">    	&#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eat</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"cat eat meat"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hunt</span><span class="params">()</span></span>&#123;</span><br><span class="line">            System.out.println(<span class="string">"cat hunt"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shotAnimal</span><span class="params">(Animal animal)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        animal.eat(); <span class="comment">//表现为晚期绑定</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">shotHunt</span><span class="params">(Huntable hunt)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        hunt.hunt(); <span class="comment">//表现为晚期绑定</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number96.jpg" alt></p>
<h4 id="虚方法和非虚方法"><a href="#虚方法和非虚方法" class="headerlink" title="虚方法和非虚方法"></a>虚方法和非虚方法</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number97.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number98.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number99.jpg" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Father</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Father</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"构造器"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showStatic</span><span class="params">(String str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">showFinal</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"final"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showCommon</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"common"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Son</span> <span class="keyword">extends</span> <span class="title">Father</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Son</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Son</span><span class="params">(<span class="keyword">int</span> age)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//不是重写的父类方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showStatic</span><span class="params">(String str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(str+<span class="string">"son"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">showPrivate</span><span class="params">(String str)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        System.out.println(str+<span class="string">"private"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        showStatic(<span class="string">"aa"</span>);</span><br><span class="line">        <span class="keyword">super</span>.showStatic(<span class="string">"bb"</span>);</span><br><span class="line">        <span class="comment">/*这个应该也是special但是显示的是virtual，查阅发现JDK8是special，</span></span><br><span class="line"><span class="comment">        最新的版本是virtual</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        showPrivate(<span class="string">"cc"</span>);</span><br><span class="line">        <span class="keyword">super</span>.showCommon();</span><br><span class="line">        <span class="comment">//虽然显示的是virtual但是不是一个虚方法</span></span><br><span class="line">        showFinal();</span><br><span class="line">        showCommon();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Son son=<span class="keyword">new</span> Son();</span><br><span class="line">        son.show();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="invokedynamic指令"><a href="#invokedynamic指令" class="headerlink" title="invokedynamic指令"></a>invokedynamic指令</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number100.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number101.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number102.jpg" alt></p>
<h4 id="方法的重写"><a href="#方法的重写" class="headerlink" title="方法的重写"></a>方法的重写</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number103.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number104.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number105.jpg" alt></p>
<h3 id="方法返回地址"><a href="#方法返回地址" class="headerlink" title="方法返回地址"></a>方法返回地址</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number106.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number107.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number108.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number109.jpg" alt></p>
<h3 id="一些附加信息"><a href="#一些附加信息" class="headerlink" title="一些附加信息"></a>一些附加信息</h3><p>例如对程序调试提供支持的信息</p>
<h3 id="栈的相关面试题"><a href="#栈的相关面试题" class="headerlink" title="栈的相关面试题"></a>栈的相关面试题</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number110.jpg" alt></p>
<ol>
<li>StackOverFlowError 可以通过-Xss设置栈空间大小，<br>如果内存空间不足无法动态扩充栈空间时会出现OOM</li>
<li>不能保证，如果发生无限递归的情况一定会栈溢出</li>
<li>并不是，会挤占其它内存空间</li>
<li>不会</li>
<li>有可能存在不安全问题</li>
</ol>
<h3 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h3><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number116.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number117.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number118.jpg" alt></p>
<h3 id="堆"><a href="#堆" class="headerlink" title="堆"></a>堆</h3><p>一个进程就对应一个JVM实例，一个JVM实例就有一个运行时数据区，一个云<br>行时数据区就有一个堆，一个进程的多个线程要共享一个堆空间 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number120.jpg" alt><br>-Xms10m -Xmx10m 编译后将堆空间进行设置 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number121.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number122.jpg" alt><br>在jvisualvm中查看进程 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number123.jpg" alt> Visual GC 插件<br>可以在工具中下载，可能要多次重试 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number124.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number125.jpg" alt><br>从Eden Space到 Old Gen中的四个数值加起来是20M</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123; <span class="comment">//Main2代码跟Main一样，不过一个堆空间是10M一个是20M</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"start"</span>);</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Thread.sleep(<span class="number">100000</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)</span><br><span class="line">        &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">"end"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="堆的核心概述"><a href="#堆的核心概述" class="headerlink" title="堆的核心概述"></a>堆的核心概述</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number126.jpg" alt></p>
<h4 id="堆内存细分"><a href="#堆内存细分" class="headerlink" title="堆内存细分"></a>堆内存细分</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number127.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number128.jpg" alt></p>
<h4 id="设置堆内存大小与OOM"><a href="#设置堆内存大小与OOM" class="headerlink" title="设置堆内存大小与OOM"></a>设置堆内存大小与OOM</h4><p>设置堆空间时不包括元空间，开发中建议将初始堆内存和最大堆内存<br>设置一样大，减小系统压力。 <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number129.jpg" alt></p>
<h4 id="堆空间的大小设置和查看"><a href="#堆空间的大小设置和查看" class="headerlink" title="堆空间的大小设置和查看"></a>堆空间的大小设置和查看</h4><ul>
<li>jps/jstat -gc 进程id</li>
<li>-XX:+PrintGCDetails</li>
</ul>
<h4 id="OutOfMemory"><a href="#OutOfMemory" class="headerlink" title="OutOfMemory"></a>OutOfMemory</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number130.jpg" alt></p>
<h4 id="年轻代与老年代"><a href="#年轻代与老年代" class="headerlink" title="年轻代与老年代"></a>年轻代与老年代</h4><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number131.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number132.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number133.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number134.jpg" alt></p>
<h2 id="本地方法接口"><a href="#本地方法接口" class="headerlink" title="本地方法接口"></a>本地方法接口</h2><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number111.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number112.jpg" alt></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//native和abstract不可以共存，native方法是有方法体的</span></span><br><span class="line"><span class="meta">@HotSpotIntrinsicCandidate</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> Class&lt;?&gt; getClass(); <span class="comment">//Object</span></span><br></pre></td></tr></table></figure>
<p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number113.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number114.jpg" alt> <img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number115.jpg" alt></p>
<h2 id="JVM学习回顾"><a href="#JVM学习回顾" class="headerlink" title="JVM学习回顾"></a>JVM学习回顾</h2><p><img src="/2020/05/06/%E6%B7%B1%E5%85%A5JVM/number119.jpg" alt></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">高明</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://skysea-gaoming.github.io/2020/05/06/%E6%B7%B1%E5%85%A5JVM/">https://skysea-gaoming.github.io/2020/05/06/%E6%B7%B1%E5%85%A5JVM/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Java/">Java</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2020/07/15/IDEA/"><i class="fa fa-chevron-left">  </i><span>IDEA</span></a></div><div class="next-post pull-right"><a href="/2020/04/12/Java%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/"><span>Java基础知识</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://skysea-gaoming.github.io/2020/05/06/%E6%B7%B1%E5%85%A5JVM/';
  this.page.identifier = '2020/05/06/深入JVM/';
  this.page.title = '深入JVM';
}
var d = document, s = d.createElement('script');
s.src = "https://" + '你的disqus的 short-name' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://你的disqus的 short-name.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1591954918112&amp;di=2bc6f4358ea0e880687f5ced03157daf&amp;imgtype=0&amp;src=http%3A%2F%2Fyouimg1.c-ctrip.com%2Ftarget%2Ftg%2F620%2F406%2F859%2Fe7db3299a728401eb7b42effae33dadb.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By 高明</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script id="ribbon" src="/js/third-party/canvas-ribbon.js" size="150" alpha="0.6" zIndex="-1" data-click="false"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>