<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MySQL总结2"><meta name="keywords" content="数据库"><meta name="author" content="高明"><meta name="copyright" content="高明"><title>MySQL总结2 | SkySea-GaoMing</title><link rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script><meta name="generator" content="Hexo 4.2.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#普通索引和唯一索引如何选择"><span class="toc-number">1.</span> <span class="toc-text">普通索引和唯一索引如何选择</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询过程"><span class="toc-number">1.1.</span> <span class="toc-text">查询过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#更新过程"><span class="toc-number">1.2.</span> <span class="toc-text">更新过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#redo-log和change-buffer的区别"><span class="toc-number">1.3.</span> <span class="toc-text">redo log和change buffer的区别</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选择索引"><span class="toc-number">2.</span> <span class="toc-text">选择索引</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#扫描行数怎么判断"><span class="toc-number">2.1.</span> <span class="toc-text">扫描行数怎么判断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#给字符串加索引"><span class="toc-number">3.</span> <span class="toc-text">给字符串加索引</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#表数据和表文件"><span class="toc-number">4.</span> <span class="toc-text">表数据和表文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#数据删除流程"><span class="toc-number">4.1.</span> <span class="toc-text">数据删除流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#count"><span class="toc-number">5.</span> <span class="toc-text">count(*)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#order-by"><span class="toc-number">6.</span> <span class="toc-text">order by</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#执行流程"><span class="toc-number">6.1.</span> <span class="toc-text">执行流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#order-by原理"><span class="toc-number">6.2.</span> <span class="toc-text">order by原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL"><span class="toc-number">7.</span> <span class="toc-text">MySQL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#组合两个表"><span class="toc-number">7.1.</span> <span class="toc-text">组合两个表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第二高的薪水"><span class="toc-number">7.2.</span> <span class="toc-text">第二高的薪水</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#第N高的薪水"><span class="toc-number">7.3.</span> <span class="toc-text">第N高的薪水</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分数排名"><span class="toc-number">7.4.</span> <span class="toc-text">分数排名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#连续出现的数字"><span class="toc-number">7.5.</span> <span class="toc-text">连续出现的数字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#超过经理收入的员工"><span class="toc-number">7.6.</span> <span class="toc-text">超过经理收入的员工</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查找重复的电子邮箱"><span class="toc-number">7.7.</span> <span class="toc-text">查找重复的电子邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#从不订购的客户"><span class="toc-number">7.8.</span> <span class="toc-text">从不订购的客户</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删除重复的电子邮箱"><span class="toc-number">7.9.</span> <span class="toc-text">删除重复的电子邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#上升的温度"><span class="toc-number">7.10.</span> <span class="toc-text">上升的温度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有趣的电影"><span class="toc-number">7.11.</span> <span class="toc-text">有趣的电影</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#有座位"><span class="toc-number">7.12.</span> <span class="toc-text">有座位</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#变更性别"><span class="toc-number">7.13.</span> <span class="toc-text">变更性别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重新格式化部门表"><span class="toc-number">7.14.</span> <span class="toc-text">重新格式化部门表</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=2762516417,1589137703&amp;fm=26&amp;gp=0.jpg"></div><div class="author-info__name text-center">高明</div><div class="author-info__description text-center">JAVA工程师</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">86</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">14</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">11</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=2333247715,1420619508&amp;fm=26&amp;gp=0.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">SkySea-GaoMing</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">MySQL总结2</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-05-16</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/%E7%A7%8B%E6%8B%9B/">秋招</a><span class="post-meta__separator">|</span><i class="fa fa-comment-o post-meta__icon" aria-hidden="true"></i><a href="/2021/05/16/MySQL%E5%AE%9E%E6%88%98/#disqus_thread"><span class="disqus-comment-count" data-disqus-identifier="2021/05/16/MySQL实战/"></span></a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>1</p>
<h2 id="普通索引和唯一索引如何选择"><a href="#普通索引和唯一索引如何选择" class="headerlink" title="普通索引和唯一索引如何选择"></a>普通索引和唯一索引如何选择</h2><p>假设你在维护一个市民系统，每个人都有一个唯一的身份证号，而且业务代码<br>已经保证了不会写入两个重复的身份证号。如果市民系统需要按照身份证号查<br>姓名</p>
<h3 id="查询过程"><a href="#查询过程" class="headerlink" title="查询过程"></a>查询过程</h3><p>性能差距微乎其微，InnoDB 的数据是按数据页为单位来读写的。也就是说，<br>当需要读一条记录的时候，并不是将这个记录本身从磁盘读出来，而是以页<br>为单位，将其整体读入内存，每个数据页的大小默认是16KB。对于普通索引<br>来说，要多做的那一次“查找和判断下一条记录”的操作，就只需要一次指针<br>寻找和一次计算</p>
<ol>
<li>对于普通索引来说，查找到满足条件的第一个记录后，需要查找下一个<br>记录，直到碰到第一个不满足条件的记录</li>
<li>对于唯一索引来说，由于索引定义了唯一性，查找到第一个满足条件的<br>记录后，就会停止继续检索</li>
</ol>
<h3 id="更新过程"><a href="#更新过程" class="headerlink" title="更新过程"></a>更新过程</h3><p>当需要更新一个数据页时，如果数据页在内存中就直接更新，而如果这个数<br>据页还没有在内存中的话，在不影响数据一致性的前提下，InnoDB 会将这<br>些更新操作缓存在change buffer 中，这样就不需要从磁盘中读入这个数<br>据页了。在下次查询需要访问这个数据页的时候，将数据页读入内存，然后<br>执行change buffer 中与这个页有关的操作</p>
<ol>
<li>对于唯一索引来说，所有的更新操作都要先判断这个操作是否违反唯一<br>性约束，必须要将数据页读入内存才能判断。如果都已经读入到内存了，那<br>直接更新内存会更快，就没必要使用change buffer 了。唯一索引的更新<br>就不能使用change buffer</li>
<li>对于普通索引来说，如果这个记录要更新的目标页不在内存中，则是将<br>更新记录在change buffer。将数据从磁盘读入内存涉及随机IO 的访问，<br>是数据库里面成本最高的操作之一。change buffer 因为减少了随机磁盘<br>访问，所以对更新性能的提升是会很明显的</li>
</ol>
<h3 id="redo-log和change-buffer的区别"><a href="#redo-log和change-buffer的区别" class="headerlink" title="redo log和change buffer的区别"></a>redo log和change buffer的区别</h3><ol>
<li>redo log 主要节省的是随机写磁盘的 IO 消耗（转成顺序写），而<br>change buffer 主要节省的则是随机读磁盘的 IO 消耗</li>
<li>change buffer记录的只是针对不在内存中的数据，redo log不管数据<br>在不在内存中，都记录</li>
</ol>
<h2 id="选择索引"><a href="#选择索引" class="headerlink" title="选择索引"></a>选择索引</h2><p>优化器选择索引的目的，是找到一个最优的执行方案，并用最小的代价去执<br>行语句。在数据库里面，扫描行数是影响执行代价的因素之一。扫描的行数<br>越少，意味着访问磁盘数据的次数越少，消耗的CPU 资源越少。还会结合<br>是否使用临时表、是否排序等因素进行综合判断</p>
<h3 id="扫描行数怎么判断"><a href="#扫描行数怎么判断" class="headerlink" title="扫描行数怎么判断"></a>扫描行数怎么判断</h3><p>一个索引上不同的值越多，这个索引的区分度就越好。而一个索引上不同的<br>值的个数，我们称之为基数。也就是说这个基数越大，索引的区分度越好。</p>
<h2 id="给字符串加索引"><a href="#给字符串加索引" class="headerlink" title="给字符串加索引"></a>给字符串加索引</h2><ol>
<li>使用前缀索引，定义好长度，就可以做到既节省空间，又不用额外增加<br>太多的查询成本。在建立索引时关注的是区分度，区分度越高越好。因为区<br>分度越高，意味着重复的键值越少</li>
<li>使用前缀索引就用不上覆盖索引对查询性能的优化了，这也是你在选择<br>是否使用前缀索引时需要考虑的一个因素</li>
<li>遇到前缀的区分度不够好的情况时</li>
</ol>
<ul>
<li>第一种方式是使用倒序存储。如存储身份证号的时候把它倒过来存，每次查<br>询的时候，你可以这么写：reverse(‘input_id_card_string’);</li>
<li>第二种方式是使用hash 字段。你可以在表上再创建一个整数字段，来保存<br>身份证的校验码，同时在这个字段上创建索引。每次插入新记录的时候，都同<br>时用crc32() 这个函数得到校验码填到这个新字段。这样索引的长度变成了4<br>个字节，比原来小了很多</li>
<li>字段拆分（一个字段可拆分为两个以上）</li>
</ul>
<h2 id="表数据和表文件"><a href="#表数据和表文件" class="headerlink" title="表数据和表文件"></a>表数据和表文件</h2><p>一个InnoDB 表包含两部分：表结构定义和数据。表结构是存在以.frm 为后缀<br>的文件里。表数据既可以存在共享表空间里，也可以是单独的文件。这个行为是<br>由参数innodb_file_per_table 控制的：</p>
<ol>
<li>这个参数设置为 OFF 表示的是，表的数据放在系统共享表空间，也就是跟<br>数据字典放在一起</li>
<li>这个参数设置为 ON 表示的是，每个 InnoDB 表数据存储在一个以 .ibd<br>为后缀的文件中</li>
</ol>
<h3 id="数据删除流程"><a href="#数据删除流程" class="headerlink" title="数据删除流程"></a>数据删除流程</h3><p>假设我们要删掉某个记录，InnoDB 引擎只会把这个记录标记为删除，也就是<br>逻辑删除。如果我们删掉一个数据页上的所有记录，整个数据页就可以被复用</p>
<ol>
<li>delete 命令把整个表的数据删除，所有的数据页都会被标记为可复用。<br>但是磁盘上，文件不会变小</li>
<li>重建表，消除表因为进行大量的增删改操作而产生的空洞，空洞就是那些<br>被标记可复用但是还没被使用的存储空间</li>
</ol>
<h2 id="count"><a href="#count" class="headerlink" title="count(*)"></a>count(*)</h2><ol>
<li>MyISAM 用一个变量存储表的总行数。InnoDB 则遍历整张表进行统计</li>
<li>InnoDB 不把数字存起来，因为即使是在同一个时刻的多个查询，由于多<br>版本并发控制（MVCC）的原因，InnoDB 表“应该返回多少行”也是不确定的。<br>每一行记录都要判断自己是否对这个会话可见，因此对于count(*) 请求来<br>说，InnoDB 只好把数据一行一行地读出依次判断，可见的行才能够用于计<br>算“基于这个查询”的表的总行数</li>
<li>MySQL 优化器会找到最小的那棵树来遍历。在保证逻辑正确的前提下，尽<br>量减少扫描的数据量，是数据库系统设计的通用法则之一</li>
</ol>
<h2 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h2><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><ol>
<li>初始化sort_buffer，确定放入所要查询的字段</li>
<li>从索引city 找到第一个满足city=’杭州’条件的主键id</li>
<li>到主键id 索引取出整行，取要查询字段的值，存入sort_buffer 中</li>
<li>从索引city 取下一个记录的主键 id</li>
<li>重复步骤3、4 直到 city 的值不满足查询条件为止</li>
<li>对sort_buffer 中的数据按照字段name 做快速排序</li>
<li>按照排序结果取前1000 行返回给客户端</li>
</ol>
<h3 id="order-by原理"><a href="#order-by原理" class="headerlink" title="order by原理"></a>order by原理</h3><p>order by 有两种排序模式。全字段排序和rowid排序</p>
<ol>
<li>全字段排序 首先在sort buffer中初始化select的字段，根据where<br>条件进行过滤，然后按照order by的字段进行排序</li>
<li>rowid排序</li>
</ol>
<h2 id="MySQL"><a href="#MySQL" class="headerlink" title="MySQL"></a>MySQL</h2><h3 id="组合两个表"><a href="#组合两个表" class="headerlink" title="组合两个表"></a>组合两个表</h3><p>当使用join连接时连接条件必须是on，left join会返回左边全部记录，<br>MySQL不支持全外连接，内连接和自然连接的唯一区别就在于自然连接必<br>需是相同属性（名字相同），可以不写连接条件。内连接放宽了限制，两<br>个属性列不必同名。using只能用于属性同名，on也可以用在属性不同名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> FirstName,LastName,City,State <span class="keyword">from</span> Person p <span class="keyword">left</span> <span class="keyword">join</span> Address a</span><br><span class="line"><span class="keyword">on</span> p.PersonId=a.PersonId;</span><br></pre></td></tr></table></figure>
<p>全外连接可以使用以下语句完成，union用于合并多个SELECT语句的结果<br>集，如果要允许重复可以使用 union all</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> FirstName,LastName,City,State <span class="keyword">from</span> Person p <span class="keyword">left</span> <span class="keyword">join</span> Address a</span><br><span class="line"><span class="keyword">on</span> p.PersonId=a.PersonId <span class="keyword">union</span> <span class="keyword">select</span> FirstName,LastName,City,State </span><br><span class="line"><span class="keyword">from</span> Person p <span class="keyword">right</span> <span class="keyword">join</span> Address a <span class="keyword">on</span> p.PersonId=a.PersonId;</span><br></pre></td></tr></table></figure>
<h3 id="第二高的薪水"><a href="#第二高的薪水" class="headerlink" title="第二高的薪水"></a>第二高的薪水</h3><p>limit position,count 从索引位置开始count个数据，索引从0开始，<br>现在要查询第N高的薪水只需要修改为 limit N-1,1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">ifNull</span>((<span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> Employee </span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> Salary <span class="keyword">Desc</span> <span class="keyword">limit</span> <span class="number">1</span>,<span class="number">1</span>),<span class="literal">null</span>) <span class="keyword">as</span> SecondHighestSalary;</span><br></pre></td></tr></table></figure>
<h3 id="第N高的薪水"><a href="#第N高的薪水" class="headerlink" title="第N高的薪水"></a>第N高的薪水</h3><p>首先要清楚函数的格式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> 函数名(参数列表) <span class="keyword">returns</span> 返回类型</span><br><span class="line"><span class="keyword">begin</span> </span><br><span class="line">	<span class="keyword">declare</span> c <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">set</span> c=<span class="number">1</span>;</span><br><span class="line">	函数体 into c</span><br><span class="line">	return c;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">select</span> 函数名(参数列表)</span><br></pre></td></tr></table></figure>
<p>这个题不需要使用ifNull，因为不需要起一个别名</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary(N <span class="built_in">INT</span>) <span class="keyword">RETURNS</span> <span class="built_in">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">set</span> N=N<span class="number">-1</span>;</span><br><span class="line">  RETURN (</span><br><span class="line">      <span class="comment"># Write your MySQL query statement below.</span></span><br><span class="line">      <span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> Employee <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      salary <span class="keyword">desc</span> <span class="keyword">limit</span> N,<span class="number">1</span> </span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<p>也可以这样写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">FUNCTION</span> getNthHighestSalary(N <span class="built_in">INT</span>) <span class="keyword">RETURNS</span> <span class="built_in">INT</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">    <span class="keyword">set</span> N=N<span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">declare</span> c <span class="built_in">int</span> <span class="keyword">default</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">distinct</span> salary <span class="keyword">from</span> Employee <span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">      salary <span class="keyword">desc</span> <span class="keyword">limit</span> N,<span class="number">1</span> <span class="keyword">into</span> c;</span><br><span class="line">  RETURN (</span><br><span class="line">      <span class="comment"># Write your MySQL query statement below.</span></span><br><span class="line">      c</span><br><span class="line">  );</span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>
<h3 id="分数排名"><a href="#分数排名" class="headerlink" title="分数排名"></a>分数排名</h3><p>这个问题看起来有点复杂，可以分成两部分解决。第一部分就是得到降序<br>排列的分数，第二部分就是分数的排名。给定一个分数与自己对照如果有<br>N个不重复分数大于等于这个分数那么这个分数的排名就是N</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.Score,<span class="keyword">count</span>(<span class="keyword">distinct</span>(b.Score)) <span class="string">'Rank'</span></span><br><span class="line"><span class="keyword">from</span> Scores a,Scores b <span class="keyword">where</span> a.Score&lt;=b.Score</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a.ID <span class="keyword">order</span> <span class="keyword">by</span> a.Score <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<p>还可以这样写</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a.Score <span class="keyword">as</span> Score,(<span class="keyword">select</span> <span class="keyword">count</span>(<span class="keyword">distinct</span>(b.Score))</span><br><span class="line"><span class="keyword">from</span> Scores b <span class="keyword">where</span> a.Score&lt;=b.Score ) <span class="keyword">as</span> <span class="string">`Rank`</span></span><br><span class="line"><span class="keyword">from</span> Scores a  <span class="keyword">order</span> <span class="keyword">by</span> a.Score <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure>
<p>如果使用函数的话有三种函数可以使用，RANK，DENSE_RANK和ROW_NUMBER<br><img src="/2021/05/16/MySQL%E5%AE%9E%E6%88%98/2.jpg" alt></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> score, <span class="keyword">DENSE_RANK</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> Score <span class="keyword">DESC</span>) <span class="keyword">as</span> <span class="string">'Rank'</span></span><br><span class="line"><span class="keyword">from</span> Scores;</span><br></pre></td></tr></table></figure>
<h3 id="连续出现的数字"><a href="#连续出现的数字" class="headerlink" title="连续出现的数字"></a>连续出现的数字</h3><p>我看到的题解中最简单的方法是使用窗口函数，将num列复制两次，现在需要<br>获得连续三个数的话num1列上移一次，num2列上移两次</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Write your MySQL query statement below</span></span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> <span class="keyword">num</span> <span class="keyword">as</span> ConsecutiveNums  <span class="keyword">from</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">select</span> <span class="keyword">num</span>,<span class="keyword">lead</span>(<span class="keyword">num</span>,<span class="number">1</span>)<span class="keyword">over</span>()<span class="keyword">as</span> num1,<span class="keyword">lead</span>(<span class="keyword">num</span>,<span class="number">2</span>)<span class="keyword">over</span>()<span class="keyword">as</span> num2 </span><br><span class="line">    <span class="keyword">from</span> <span class="keyword">logs</span></span><br><span class="line">) <span class="keyword">as</span> c</span><br><span class="line"><span class="keyword">where</span> c.num = c.num1 <span class="keyword">and</span> c.num1 = c.num2</span><br></pre></td></tr></table></figure>
<p>还有一种更好的方法，思路也很清晰，但是实现很复杂。首先根据id获取<br>一个排序，然后将num分组排序。这两个列相减如果值一样说明是重复的<br>值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Id</span>,<span class="keyword">Num</span>,</span><br><span class="line">row_number() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) <span class="keyword">as</span> SerialNum</span><br><span class="line"><span class="keyword">FROM</span> ContinueNumber</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Id</span>,<span class="keyword">Num</span>,</span><br><span class="line">ROW_NUMBER() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">Num</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">Id</span>) <span class="keyword">as</span> SerialGroup</span><br><span class="line"><span class="keyword">FROM</span> ContinueNumber</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> <span class="keyword">Num</span> <span class="keyword">FROM</span> (</span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">Num</span>,<span class="keyword">COUNT</span>(<span class="number">1</span>) <span class="keyword">as</span> SerialCount <span class="keyword">FROM</span> </span><br><span class="line">(<span class="keyword">SELECT</span> <span class="keyword">Id</span>,<span class="keyword">Num</span>,</span><br><span class="line">row_number() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span>) -</span><br><span class="line">ROW_NUMBER() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> <span class="keyword">Num</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">Id</span>) <span class="keyword">as</span> SerialNumberSubGroup</span><br><span class="line"><span class="keyword">FROM</span> ContinueNumber) <span class="keyword">as</span> Sub</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">Num</span>,SerialNumberSubGroup <span class="keyword">HAVING</span> <span class="keyword">COUNT</span>(<span class="number">1</span>) &gt;= <span class="number">3</span>) <span class="keyword">as</span> <span class="keyword">Result</span></span><br></pre></td></tr></table></figure>
<p>还有一种简明解法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">DISTINCT</span> L1.num ConsecutiveNums</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    <span class="keyword">Logs</span> L1,</span><br><span class="line">    <span class="keyword">Logs</span> L2,</span><br><span class="line">    <span class="keyword">Logs</span> L3</span><br><span class="line"><span class="keyword">WHERE</span> L1.id = l2.id - <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> L2.id = L3.id - <span class="number">1</span></span><br><span class="line">    <span class="keyword">AND</span> L1.num = L2.num</span><br><span class="line">    <span class="keyword">AND</span> l2.num = l3.num;</span><br></pre></td></tr></table></figure>

<h3 id="超过经理收入的员工"><a href="#超过经理收入的员工" class="headerlink" title="超过经理收入的员工"></a>超过经理收入的员工</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select a.Name as Employee from Employee a where Salary&gt;</span><br><span class="line">(select b.Salary from Employee b where a.ManagerId&#x3D;b.Id);</span><br></pre></td></tr></table></figure>
<h3 id="查找重复的电子邮箱"><a href="#查找重复的电子邮箱" class="headerlink" title="查找重复的电子邮箱"></a>查找重复的电子邮箱</h3><p>奇怪为什么把in换成=就出错</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select distinct(a.Email) from Person a where a.Email in</span><br><span class="line">(select b.Email from Person b  group by b.Email having count(*)&gt;1);</span><br></pre></td></tr></table></figure>
<h3 id="从不订购的客户"><a href="#从不订购的客户" class="headerlink" title="从不订购的客户"></a>从不订购的客户</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select Name as Customers from Customers  where</span><br><span class="line">Id not in (select CustomerId from Orders)</span><br></pre></td></tr></table></figure>
<h3 id="删除重复的电子邮箱"><a href="#删除重复的电子邮箱" class="headerlink" title="删除重复的电子邮箱"></a>删除重复的电子邮箱</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete p1 from Person p1,Person p2 where p1.Email &#x3D; p2.Email and p1.Id &gt; p2.Id</span><br></pre></td></tr></table></figure>
<h3 id="上升的温度"><a href="#上升的温度" class="headerlink" title="上升的温度"></a>上升的温度</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select a.id from Weather a,Weather b where a.Temperature&gt;b.Temperature </span><br><span class="line">and datediff(a.recordDate,b.recordDate)&#x3D;1;</span><br></pre></td></tr></table></figure>
<h3 id="有趣的电影"><a href="#有趣的电影" class="headerlink" title="有趣的电影"></a>有趣的电影</h3><p>终于有一道会的了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,movie,description,rating <span class="keyword">from</span> cinema</span><br><span class="line"><span class="keyword">where</span> description!=<span class="string">'boring'</span> <span class="keyword">and</span> <span class="keyword">id</span>%<span class="number">2</span>=<span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> rating <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="有座位"><a href="#有座位" class="headerlink" title="有座位"></a>有座位</h3><p>大佬的思路就是不一样，换name的话比较麻烦直接换id就好了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> (<span class="keyword">CASE</span> </span><br><span class="line">            <span class="keyword">WHEN</span> <span class="keyword">MOD</span>(<span class="keyword">id</span>,<span class="number">2</span>) = <span class="number">1</span> <span class="keyword">AND</span> <span class="keyword">id</span> = (<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">FROM</span> seat) <span class="keyword">THEN</span> <span class="keyword">id</span></span><br><span class="line">            <span class="keyword">WHEN</span> <span class="keyword">MOD</span>(<span class="keyword">id</span>,<span class="number">2</span>) = <span class="number">1</span> <span class="keyword">THEN</span> <span class="keyword">id</span>+<span class="number">1</span></span><br><span class="line">            <span class="keyword">ElSE</span> <span class="keyword">id</span><span class="number">-1</span></span><br><span class="line">        <span class="keyword">END</span>) <span class="keyword">AS</span> <span class="keyword">id</span>, student</span><br><span class="line"><span class="keyword">FROM</span> seat</span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>
<h3 id="变更性别"><a href="#变更性别" class="headerlink" title="变更性别"></a>变更性别</h3><p>一开始没想到用三目运算符</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> salary <span class="keyword">set</span> sex = <span class="keyword">if</span>(sex = <span class="string">'m'</span>,<span class="string">'f'</span>,<span class="string">'m'</span>);</span><br></pre></td></tr></table></figure>
<p>还有一种很巧妙的方法就是异或</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">UPDATE</span> salary <span class="keyword">SET</span> sex = <span class="built_in">CHAR</span> ( <span class="keyword">ASCII</span>(sex) ^ <span class="keyword">ASCII</span>( <span class="string">'m'</span> ) ^ <span class="keyword">ASCII</span>( <span class="string">'f'</span> ) );</span><br></pre></td></tr></table></figure>
<h3 id="重新格式化部门表"><a href="#重新格式化部门表" class="headerlink" title="重新格式化部门表"></a>重新格式化部门表</h3><p>在select子句中出现了group by子句中没有出现的列名revenue，而这种<br>写法在SQL标准中是没有的，MySQL允许这种写法实际会造成一种错觉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Jan'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Jan_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Feb'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Feb_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Mar'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Mar_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Apr'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Apr_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'May'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> May_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Jun'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Jun_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Jul'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Jul_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Aug'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Aug_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Sep'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Sep_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Oct'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Oct_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Nov'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Nov_Revenue,</span><br><span class="line">    <span class="keyword">sum</span>(<span class="keyword">case</span> <span class="keyword">month</span> <span class="keyword">when</span> <span class="string">'Dec'</span> <span class="keyword">then</span> revenue <span class="keyword">end</span>) <span class="keyword">as</span> Dec_Revenue</span><br><span class="line"><span class="keyword">from</span> Department</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>;</span><br></pre></td></tr></table></figure>

</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">高明</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://skysea-gaoming.github.io/2021/05/16/MySQL%E5%AE%9E%E6%88%98/">https://skysea-gaoming.github.io/2021/05/16/MySQL%E5%AE%9E%E6%88%98/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/05/17/Redis%E6%80%BB%E7%BB%93/"><i class="fa fa-chevron-left">  </i><span>Redis总结</span></a></div><div class="next-post pull-right"><a href="/2021/05/11/%E9%AB%98%E5%B9%B6%E5%8F%91%E9%80%89%E8%AF%BE%E9%A1%B9%E7%9B%AE3/"><span>高并发选课项目3</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://skysea-gaoming.github.io/2021/05/16/MySQL%E5%AE%9E%E6%88%98/';
  this.page.identifier = '2021/05/16/MySQL实战/';
  this.page.title = 'MySQL总结2';
}
var d = document, s = d.createElement('script');
s.src = "https://" + '你的disqus的 short-name' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script><script id="dsq-count-scr" src="https://你的disqus的 short-name.disqus.com/count.js" async></script></div></div><footer class="footer-bg" style="background-image: url(https://ss1.bdstatic.com/70cFvXSh_Q1YnxGkpoWK1HF6hhy/it/u=2333247715,1420619508&amp;fm=26&amp;gp=0.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2021 By 高明</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody" target="_blank" rel="noopener"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>